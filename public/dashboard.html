<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Porquinho M√°gico</title>
    <link rel="stylesheet" href="dashboard.css">
    <style>
       
    </style>
</head>
<body>
    <header>
        <h1>Porquinho M√°gico</h1>
        <ul>
            <li><a href="jokenpo.html">‚úåÔ∏èJokenpo‚úä</a></li>
            <li><a href="presente.html">Presentear</a></li>
            <li id="notificacoes">üîî <span class="badge"></span></li>
        </ul>
    </header>

    <!-- Se√ß√£o de notifica√ß√µes -->
    <div id="notificacoesPresentes">
        <h2>Notifica√ß√µes</h2>
        <ul id="listaPresentes"></ul>
        <button id="limparNotificacoes">Limpar Notifica√ß√µes</button>
    </div>

    <h2>Sua Conta Banc√°ria</h2>
    <img src="img/poupanca.png" alt="Imagem de poupan√ßa" width="300px">
    <div id="usuario"></div> <!-- Mensagem de boas-vindas -->
    <div id="saldoContainer">
        <h2>Seu Saldo</h2>
        <div id="saldo"></div>
    </div>

    <div id="transferMsg" class="error"></div>
    <h2>Transferir Dinheiro</h2>
    <form id="transferForm">
        <label for="destinatario">Destinat√°rio:</label>
        <select id="destinatario" name="destinatario" required></select>

        <label for="valor">Valor:</label>
        <input type="number" id="valor" name="valor" required>
        <button type="submit">Transferir</button>
    </form>

    <script>
        // Fun√ß√£o para carregar os jogadores no seletor de destinat√°rio
        async function carregarJogadores() {
            try {
                const response = await fetch('/saldo-jogadores');
                const data = await response.json();

                if (data.success) {
                    const jogadores = data.jogadores;
                    const destinatarioSelect = document.getElementById('destinatario');
                    destinatarioSelect.innerHTML = '';

                    jogadores.forEach(jogador => {
                        const option = document.createElement('option');
                        option.value = jogador.username;
                        option.textContent = jogador.username;
                        destinatarioSelect.appendChild(option);
                    });
                } else {
                    console.error('Erro ao carregar jogadores:', data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar jogadores:', error);
            }
        }

        // Fun√ß√£o para carregar o saldo do jogador
        async function carregarSaldo() {
            const username = localStorage.getItem('username');
            try {
                const response = await fetch(`/saldo/${username}`);
                const data = await response.json();

                if (data.success) {
                    const saldoElement = document.getElementById('saldo');
                    saldoElement.textContent = parseFloat(data.saldo).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                } else {
                    console.error('Erro ao carregar saldo:', data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar saldo:', error);
            }
        }

        // Fun√ß√£o para carregar notifica√ß√µes de presentes
        async function carregarNotificacoes() {
            const username = localStorage.getItem('username');
            try {
                const response = await fetch('/presentes-recebidos');
                const data = await response.json();

                const listaPresentes = document.getElementById('listaPresentes');
                listaPresentes.innerHTML = ''; // Limpa a lista

                if (data.presentesRecebidos) {
                    const jogadorPresentes = data.presentesRecebidos.find(jogador => jogador.username === username);
                    if (jogadorPresentes && jogadorPresentes.presentes.length > 0) {
                        jogadorPresentes.presentes.forEach(presente => {
                            const listItem = document.createElement('li');
                            listItem.innerHTML = `
                                <img src="${presente.imagem}" alt="${presente.item}">
                                <div>
                                    <strong>${presente.item}</strong> <br>
                                    <em>${presente.tipoItem}</em> <br>
                                    ${presente.descricao} <br>
                                    Tipo da caixa: ${presente.tipo}
                                </div>
                            `;
                            listaPresentes.appendChild(listItem);
                        });

                        // Adiciona a classe ativa ao sino
                        document.getElementById('notificacoes').classList.add('active');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar notifica√ß√µes de presentes:', error);
            }
        }

        // Fun√ß√£o para limpar notifica√ß√µes
        function limparNotificacoes() {
            const listaPresentes = document.getElementById('listaPresentes');
            listaPresentes.innerHTML = ''; // Limpa a lista de notifica√ß√µes
            document.querySelector('#notificacoes .badge').style.display = 'none'; // Remove a bolinha vermelha
            document.getElementById('notificacoesPresentes').style.display = 'none'; // Fecha a √°rea de notifica√ß√µes
            document.getElementById('notificacoes').classList.remove('active'); // Remove destaque do sino
        }

        // Alterna a exibi√ß√£o da √°rea de notifica√ß√µes
        document.getElementById('notificacoes').addEventListener('click', (event) => {
            const notificacoesDiv = document.getElementById('notificacoesPresentes');
            notificacoesDiv.style.display = (notificacoesDiv.style.display === 'block') ? 'none' : 'block';
            event.stopPropagation(); // Evita que o clique feche a notifica√ß√£o
        });

        // Fun√ß√£o para fechar notifica√ß√µes ao clicar fora da √°rea
        document.addEventListener('click', (event) => {
            const notificacoesDiv = document.getElementById('notificacoesPresentes');
            if (!notificacoesDiv.contains(event.target) && notificacoesDiv.style.display === 'block') {
                notificacoesDiv.style.display = 'none';
            }
        });

        // Bot√£o para limpar notifica√ß√µes
        document.getElementById('limparNotificacoes').addEventListener('click', limparNotificacoes);

        // Evento de submiss√£o do formul√°rio de transfer√™ncia
        document.getElementById('transferForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const username = localStorage.getItem('username');
            const destinatario = document.getElementById('destinatario').value;
            const valor = parseFloat(document.getElementById('valor').value);

            try {
                const response = await fetch('/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, destinatario, valor }),
                });

                const data = await response.json();
                if (data.message) {
                    alert(data.message);
                }
                carregarSaldo(); // Atualiza o saldo ap√≥s a transfer√™ncia
            } catch (error) {
                console.error('Erro ao transferir:', error);
            }
        });

        // Chama as fun√ß√µes quando a p√°gina for carregada
        window.onload = async function () {
            const username = localStorage.getItem('username');
            document.getElementById('usuario').textContent = `Bem-vindo, ${username}!`;

            await carregarJogadores(); // Carrega a lista de jogadores
            await carregarSaldo(); // Carrega o saldo do jogador
            await carregarNotificacoes(); // Carrega as notifica√ß√µes de presentes
        }
    </script>
</body>
</html>
